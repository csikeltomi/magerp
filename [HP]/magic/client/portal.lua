local a=1000;local b=nil;local c=100;local d=false;local e=false;local f=false;local g=false;RegisterNetEvent("Magic:SetPortals")AddEventHandler("Magic:SetPortals",function(h)if active_portal~=nil and h==nil then TriggerServerEvent("vSync:SetWeather",'RAIN')end;b=h end)function PlayPortalEffect(i,j,k,l,m)Citizen.CreateThread(function()UseParticleFxAssetNextCall(i)local n=StartParticleFxLoopedAtCoord(j,k,l,m,0.0,0.0,GetEntityHeading(PlayerPedId()),2.0,false,false,false,false)Citizen.Wait(1000)StopParticleFxLooped(n,0)end)end;Citizen.CreateThread(function()while true do if b then if#(b.coords-GetEntityCoords(GetPlayerPed(-1)))<5 then g=true else g=false end end;Wait(1000)end end)RegisterCommand('portal',function(o,p,q)local r=GetEntityCoords(PlayerPedId())print("OPEN PORTAL COMMAND")TriggerServerEvent('Magic:CreatePortal',r,1)end,true)function LoadPortal()Citizen.CreateThread(function()local s=PlayerPedId()RequestAnimDict("rcmbarry")while not HasAnimDictLoaded("rcmbarry")do Citizen.Wait(0)end;TaskPlayAnim(s,"rcmbarry","mind_control_b_loop",1.0,-1.0,5000,1,1,true,true,true)end)end;Citizen.CreateThread(function()while true do if b and not d then PortalOpened()elseif not b then d=false end;Wait(1000)end end)Citizen.CreateThread(function()while true do if b and g then if IsControlJustReleased(0,51)then if e then exports['dpemotes']:EmoteCancel()e=false end end;if IsControlJustPressed(0,51)then if not e then e=true;ExecuteCommand('e mindcontrol2')end end;if IsControlJustReleased(0,19)then if f then exports['dpemotes']:EmoteCancel()f=false end end;if IsControlJustPressed(0,19)then if not f then f=true;ExecuteCommand('e mindcontrol2')end end end;Wait(0)end end)function PortalOpened()d=true;local t=vector3(b.coords.x,b.coords.y,b.coords.z-1)-vector3(b.coords.x,b.coords.y,b.coords.z)Citizen.CreateThread(function()while b do if#(b.coords-GetEntityCoords(GetPlayerPed(-1)))<5 and not b.open and CheckMana(c)and e then SpendMana(c)TriggerServerEvent('Magic:SetMana',c/2)end;if#(b.coords-GetEntityCoords(GetPlayerPed(-1)))<5 and b.open and CheckMana(c)and f then SpendMana(c)print('Unload')TriggerServerEvent('Magic:SetMana',c/2*-1)end;Wait(1000)end end)Citizen.CreateThread(function()while b do if not b.open then DrawSpotLight(b.coords.x,b.coords.y,b.coords.z+10,t,255,0,0,25.0,100.0,0.0,15.0)else DrawSpotLight(b.coords.x,b.coords.y,b.coords.z+10,t,0,0,255,50.0,100.0,0.0,10.0)end;Wait(0)end end)Citizen.CreateThread(function()while b do local u,v,w=0;u=math.floor(120-b.mana/1000*20)w=math.floor(b.mana/1000*20)for x=1,500,2.5 do DrawSpotLight(b.coords.x,b.coords.y,b.coords.z+100,t,u,v,w,x,10.0-x/50,1.0,10000.0)Wait(0)end;Wait(2000)end end)Citizen.CreateThread(function()while b do local u=2;local y=0;for x=1,360,60 do if b.mana/1000>y then y=y+1 else break end;local z=x*math.pi/180;local A,B=b.coords.x+u*math.cos(z),b.coords.y+u*math.sin(z)PlayPortalEffect("core","ent_ray_fam3_dust_motes",A,B,b.coords.z-1)PlayPortalEffect("core","ent_amb_torch_fire",A,B,b.coords.z-1)end;if b.open then local C=1;for x=1,360,60 do local z=x*math.pi/180;local A,B=b.coords.x+C*math.cos(z),b.coords.y+C*math.sin(z)PlayPortalEffect("core","ent_amb_steam_vent_open_hvy",A,B,b.coords.z-1)PlayPortalEffect("core","ent_amb_steam_vent_open_hvy",A,B,b.coords.z)PlayPortalEffect("core","ent_amb_steam_vent_open_hvy",A,B,b.coords.z+1)end;TriggerEvent('TELEPORT:RegisterPortal','DARK',b.coords,b.target)end;Wait(1000)end end)end
