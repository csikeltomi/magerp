local a={}local b="box"local c=nil;local d=nil;local e=nil;local f=nil;local g=[[ Ezennel elfoagom, hogy minden jutalmam, amely a szerződésből származott volna megszűnik. ]]local h={}ESX=nil;Citizen.CreateThread(function()while ESX==nil do TriggerEvent("esx:getSharedObject",function(i)ESX=i end)Citizen.Wait(0)end end)function SyncDungeons()ESX.TriggerServerCallback("Dungeon:GetDungeons",function(j)a=j;for k,l in pairs(a)do local m=l.Text;if l.innerPlayers>0 then m="Küldetés folyamatban. ~n~"..l.innerPlayers..'/5'.." varázsló tartózkodik bent."end;TriggerEvent("NPCs:CreateNPC",l.startCoords,l.heading,l.Name,l.Model,m)local n=AddBlipForCoord(l.startCoords)SetBlipSprite(n,310)SetBlipDisplay(n,4)SetBlipScale(n,0.8)SetBlipColour(n,50)SetBlipAsShortRange(n,true)BeginTextCommandSetBlipName("STRING")AddTextComponentString(l.Name)EndTextCommandSetBlipName(n)end end)end;RegisterNetEvent("Dungeon:CreateDungeon")AddEventHandler("Dungeon:CreateDungeon",function(o,p)e=o.Quest;d=p;CreateNPCs()CreateLadakDungeon()end)RegisterNetEvent("Dungeon:JoinDungeon")AddEventHandler("Dungeon:JoinDungeon",function(o,p)e=o.Quest;d=p;CreateLadakDungeon()end)RegisterNetEvent("Dungeon:UpdateDungeons")AddEventHandler("Dungeon:UpdateDungeons",function(q)a=q end)RegisterNetEvent("Dungeon:CreateExit")AddEventHandler("Dungeon:CreateExit",function()while e~=nil do DrawMarker(2,a[d].exitCoords,0.0,0.0,0.0,180.0,0.0,0.0,0.5,0.5,0.5,255,0,0,255,false,true,2,false,false,false,false)if#(a[d].exitCoords-GetEntityCoords(GetPlayerPed(-1)))<2.0 then SetTextComponentFormat("STRING")AddTextComponentString('Nyomj ~INPUT_CONTEXT~-t a kilépéshez')DisplayHelpTextFromStringLabel(0,0,1,-1)if IsControlJustPressed(0,38)and e~=nil then TriggerServerEvent("Dungeon:LeaveDungeon",d)TriggerEvent("Dungeon:EndQuest")end end;Wait(0)end end)RegisterNetEvent("Dungeon:UpdateFromServer")AddEventHandler("Dungeon:UpdateFromServer",function()SyncDungeons()end)function WaitESX()while ESX==nil do Wait(100)end end;local r={}local s={}Citizen.CreateThread(function()WaitESX()while true do SyncDungeons()Wait(30000)end end)AddEventHandler('esx:onPlayerSpawn',function(t)WaitESX()SyncDungeons()end)Citizen.CreateThread(function()while true do for u,v in pairs(a)do if v.innerPlayers>0 then local w=GetEntityCoords(GetPlayerPed(-1),false)local x=#(w-v.center)if x<=v.radius and e==nil then local y=GetEntityHealth(PlayerPedId())if y>40 then SetEntityHealth(PlayerPedId(),y-40)end end;if x>=v.radius and e~=nil then end end end;Wait(1000)end end)Citizen.CreateThread(function()while true do Citizen.Wait(0)if e then for z in EnumeratePeds()do if#(GetEntityCoords(z)-GetEntityCoords(GetPlayerPed(-1)))<20.0 and HasEntityClearLosToEntity(PlayerPedId(),z,17)and not IsPedAPlayer(z)then local A=GetEntityHealth(z)if A>0 then DrawText3D(GetEntityCoords(z),A,255,255,255,1.2)end end end end;for u,v in pairs(a)do local w=GetEntityCoords(GetPlayerPed(-1),false)local B=#(w-v.startCoords)if B<=v.radius+100.0 and v.innerPlayers>0 then DrawMarker(28,v.center,0.0,0.0,0.0,0.0,0.0,0.0,v.radius,v.radius,v.radius,0,0,0,255,false,true,2,false,false,false,false)end;if B<=10.0 then DrawMarker(27,v.startCoords,0.0,0.0,0.0,0.0,0.0,0.0,10.0,10.0,10.0,255,255,255,255,false,false,2,true,false,false,false)end;if B<=2.0 then if not e and v.Quest then SetTextComponentFormat("STRING")AddTextComponentString('Nyomj ~INPUT_CONTEXT~-t a küldetéshez')DisplayHelpTextFromStringLabel(0,0,1,-1)end;if IsControlJustPressed(0,38)and e==nil then print("TRIGGER EVENT "..u)TriggerServerEvent("Dungeon:StartDungeon",u)end end end end end)local function C()for u,v in pairs(s)do RemoveBlip(v)end end;RegisterNetEvent("Dungeon:EndQuest")AddEventHandler("Dungeon:EndQuest",function()if e then TriggerServerEvent("Dungeon:LeaveDungeon",d)end;e=nil;d=nil;C()DeleteDungeonLadak()end)RegisterNetEvent("Dungeon:UpdateQuest")AddEventHandler("Dungeon:UpdateQuest",function(D)e=D end)local E={}function CreateLadakDungeon()for F,G in pairs(e.NeedToFindInBox)do local n=AddBlipForCoord(G.Coords)SetBlipSprite(n,478)SetBlipDisplay(n,4)SetBlipScale(n,0.9)SetBlipColour(n,46)SetBlipAsShortRange(n,false)BeginTextCommandSetBlipName("STRING")AddTextComponentString("Láda")EndTextCommandSetBlipName(n)E[F]={posx=G.Coords.x,posy=G.Coords.y,posz=G.Coords.z-1.0,blip=n}end;for u,v in pairs(E)do while not HasModelLoaded(GetHashKey(b))do RequestModel(GetHashKey(b))Wait(1)end;local H=CreateObjectNoOffset(GetHashKey(b),v.posx,v.posy,v.posz,false,true,false)E[u].object=H end;SetModelAsNoLongerNeeded(GetHashKey(b))end;function DeleteDungeonLadak()for u,v in pairs(E)do while not HasModelLoaded(GetHashKey(b))do RequestModel(GetHashKey(b))Wait(1)end;if v.object then RemoveBlip(v.blip)DeleteObject(v.object)end;E[u]=nil end end;function tablelength(I)local J=0;for K in pairs(I)do J=J+1 end;return J end;function CreateNPCs()for u,v in pairs(e.NeedToKill)do local L=GetHashKey(v.model)RequestModel(L)while not HasModelLoaded(L)do Citizen.Wait(1)end;local M=CreatePed(29,L,v.coords.x,v.coords.y,v.coords.z,v.heading,true,true)local N=NetworkGetNetworkIdFromEntity(M)SetOnline(N)SetPedRelationshipGroupHash(M,GetHashKey("AGGRESSIVE_INVESTIGATE"))SetEntityHealth(M,v.health)TaskWanderInArea(M,v.coords,v.area,0.0,5.0)GiveWeaponToPed(M,GetHashKey(v.weapon),999,false,true)SetPedAccuracy(M,v.accuary)SetPedCanRagdollFromPlayerImpact(M,false)SetPedCanRagdoll(M,false)SetPedConfigFlag(M,430,true)SetPedConfigFlag(M,456,false)SetPedConfigFlag(M,294,true)SetPedDiesWhenInjured(M,false)e.NeedToKill[u]["ped"]=M;SetRelationshipBetweenGroups(5,GetHashKey('PLAYER'),GetHashKey("AGGRESSIVE_INVESTIGATE"))SetRelationshipBetweenGroups(5,GetHashKey("AGGRESSIVE_INVESTIGATE"),GetHashKey('PLAYER'))SetRelationshipBetweenGroups(0,GetHashKey("AGGRESSIVE_INVESTIGATE"),GetHashKey("AGGRESSIVE_INVESTIGATE"))end end;Citizen.CreateThread(function()while true do if e then for u,v in pairs(e.NeedToKill)do if v.ped then ResetPedRagdollTimer(v.ped)StopCurrentPlayingSpeech(v.ped)end end end;Wait(0)end end)Citizen.CreateThread(function()while true do if e then for u,v in pairs(e.NeedToKill)do if v.ped~=nil then if GetEntityHealth(v.ped)==0 then e.NeedToKill[u]["deathPosition"]=GetEntityCoords(v.ped)TriggerServerEvent('Dungeon:ExchangeItems',d,e)DeleteEntity(v.ped)e.NeedToKill[u].ped=nil elseif#(v.coords-GetEntityCoords(v.ped))>v.area*3 then TaskGoToCoordAnyMeans(v.ped,v.coords,2.0,0,false,786603,1.0)end end end end;Wait(5000)end end)Citizen.CreateThread(function()while true do Wait(5000)end end)function SetOnline(N)SetNetworkIdExistsOnAllMachines(N,true)SetNetworkIdCanMigrate(N,true)end;function hintToDisplay(O)SetTextComponentFormat("STRING")AddTextComponentString(O)AddTextComponentString(O)DisplayHelpTextFromStringLabel(0,0,1,-1)end;AddEventHandler('esx_treasure:hasEnteredMarker',function(P,Q)if LastZone=='containerzone'then CurrentAction='open_container'CurrentActionMsg='Nyomj ~INPUT_CONTEXT~-t a láda megszerzéséhez'CurrentActionData={zone=P}CurrentActionName=Q end end)AddEventHandler('esx_treasure:hasExitedMarker',function(P)ESX.UI.Menu.CloseAll()end)Citizen.CreateThread(function()while E==nil do Citizen.Wait(500)end;while true do Wait(0)local R=GetEntityCoords(GetPlayerPed(-1))local S=false;local T=nil;local U=nil;for V,v in pairs(E)do if Vdist(R,vector3(v.posx,v.posy,v.posz))<3 then S=true;T='containerzone'LastZone='containerzone'U=V end end;if S and not HasAlreadyEnteredMarker then HasAlreadyEnteredMarker=true;CurrentAction='open_container'CurrentActionMsg='Nyomj ~INPUT_CONTEXT~-t a láda megszerzéséhez'CurrentActionData={zone=T}CurrentActionName=U end;if not S and HasAlreadyEnteredMarker then HasAlreadyEnteredMarker=false;CurrentAction=nil end end end)Citizen.CreateThread(function()while E==nil do Citizen.Wait(500)end;while true do Citizen.Wait(0)if CurrentAction~=nil then SetTextComponentFormat('STRING')AddTextComponentString(CurrentActionMsg)DisplayHelpTextFromStringLabel(0,0,1,-1)if IsControlJustReleased(0,38)then if CurrentAction=='open_container'then for V,v in pairs(E)do if V==CurrentActionName then local W=GetClosestObjectOfType(v.posx,v.posy,v.posz,20.0,GetHashKey(b),true,false,false)PlaceObjectOnGroundProperly(W)DeleteEntity(W)RemoveBlip(v.blip)E[V]=nil;e.NeedToFindInBox[V]['delete']=true;TriggerServerEvent('Dungeon:ExchangeItems',d,e)end end end;CurrentAction=nil end end end end)Citizen.CreateThread(function()while E==nil do Citizen.Wait(500)end end)Citizen.CreateThread(function()while E==nil do Citizen.Wait(500)end;while true do Citizen.Wait(0)for V,v in pairs(E)do local X=vector3(v.posx,v.posy,v.posz+1.0)-vector3(v.posx,v.posy,v.posz)DrawSpotLight(v.posx,v.posy,v.posz,0.0,0.0,5.0,246,214,0,100.0,20.0,100.0,10.0,100.0)end end end)function GetCoordZHeroin(Y,Z)local _={10.0,11.0,12.0,13.0,14.0,15.0,16.0,17.0,18.0,19.0,20.0,40.0,60.0,70.0,100.0,200.0,300.0,600.0}for V,a0 in ipairs(_)do local a1,a2=GetGroundZFor_3dCoord(Y,Z,a0)if a1 then return a2 end end;return 12.64 end
